---
'$schema': https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
name: lowdefy-yaml
scopeName: source.lowdefy.yaml
comment: Lowdefy YAML syntax highlighting
patterns:
  - include: '#keys'
  - include: '#nunjucks-strings'
  - include: '#ref'
  - include: '#js-code'
  - include: '#operator'
  - include: source.yaml
fileTypes:
  - yaml
  - yml
injectionSelector: L:source.yaml -comment
repository:
  keys:
    patterns:
      - name: type.key.lowdefy.yaml
        match: '[ ]*(type):[ ]+(\w+)\n'
        captures:
          '1':
            name: keyword.declaration.key.type.key.lowdefy.yaml
          '2':
            name: entity.name.class.value.type.key.lowdefy.yaml
  ref:
    patterns:
      - name: string.unquoted.ref.operator.lowdefy.yaml
        match: '[ ]*(_ref):[ ]+(\S+)\n'
        captures:
          '1':
            name: storage.modifier.key.ref.operator.lowdefy.yaml
          '2':
            name: support.class.value.ref.operator.lowdefy.yaml
      - name: string.unquoted.path.ref.operator.lowdefy.yaml
        begin: '[ ]*(_ref):[ ]*\n'
        end: '[ ]*(path):[ ]+(\S+)\n'
        patterns:
          - include: source.yaml
        beginCaptures:
          '1':
            name: storage.modifier.key.ref.operator.lowdefy.yaml
        endCaptures:
          '1':
            name: storage.modifier.key.path.ref.operator.lowdefy.yaml
          '2':
            name: support.class.value.ref.operator.lowdefy.yaml
  nunjucks-strings:
    patterns:
      - name: string.block.nunjucks.operator.lowdefy.yaml
        begin: '[ ]*(_nunjucks):[ ]+([\|>])\s*'
        beginCaptures:
          '1':
            name: entity.name.function.key.nunjucks.operator.lowdefy.yaml
          '2':
            name: keyword.control.property.string.block.yaml
        end: ^(?=\S)|(?!\G)
        patterns:
          - name: string.block.value.nunjucks.operator.lowdefy.yaml
            begin: ^([ ]+)(?! )
            end: ^(?!\1|\s*$)
            patterns:
              - include: source.nunjucks
              - include: text.html.basic
      - name: string.block.template.nunjucks.operator.lowdefy.yaml
        begin: '[ ]*(_nunjucks):[ ]*\n'
        end: ^(?=\S)|(?!\G)
        beginCaptures:
          '1':
            name: entity.name.function.key.nunjucks.operator.lowdefy.yaml
        patterns:
          - name: string.block.template.nunjucks.operator.lowdefy.yaml
            begin: '[ ]*(template):[ ]+([\|>])\s*'
            beginCaptures:
              '1':
                name: entity.name.tag.template.nunjucks.operator.lowdefy.yaml
              '2':
                name: keyword.control.property.tag.string.block.yaml
            end: ^(?=\S)|(?!\G)
            patterns:
              - name: string.block.value.nunjucks.operator.lowdefy.yaml
                begin: ^([ ]+)(?! )
                end: ^(?!\1|\s*$)
                patterns:
                  - include: source.nunjucks
                  - include: text.html.basic
          - name: string.template.nunjucks.lowdefy.yaml
            begin: '[ ]*(template):'
            end: '\n'
            beginCaptures:
              '1':
                name: entity.name.tag.template.nunjucks.operator.lowdefy.yaml
            patterns:
              - include: source.nunjucks
              - include: text.html.basic
          - include: source.yaml

      - name: string.unquoted.nunjucks.operator.lowdefy.yaml
        begin: '[ ]*(_nunjucks):[ ].*?'
        end: \n
        beginCaptures:
          '1':
            name: entity.name.function.key.nunjucks.operator.lowdefy.yaml
        patterns:
          - include: source.nunjucks
          - include: text.html.basic

  js-code:
    patterns:
      - name: string.block.js.operator.lowdefy.yaml
        begin: '[ ]*(_js):[ ]+([\|>])\s*'
        beginCaptures:
          '1':
            name: entity.name.function.key.js.operator.lowdefy.yaml
          '2':
            name: keyword.control.property.string.block.yaml
        end: ^(?=\S)|(?!\G)
        patterns:
          - name: string.block.value.js.operator.lowdefy.yaml
            begin: ^([ ]+)(?! )
            end: ^(?!\1|\s*$)
            patterns:
              - include: source.js
      - name: string.unquoted.js.operator.lowdefy.yaml
        begin: '[ ]*(_js):[ ].*?'
        end: \n
        beginCaptures:
          '1':
            name: entity.name.function.key.js.operator.lowdefy.yaml
        patterns:
          - include: source.js

  operator:
    patterns:
      - name: operator.lowdefy.yaml
        match: '\s*(_[\w\.\_\-]+):'
        captures:
          '1':
            name: 'entity.name.function.key.operator.lowdefy.yaml'
