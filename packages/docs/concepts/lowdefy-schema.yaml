# Copyright 2020-2022 Lowdefy, Inc

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

_ref:
  path: templates/general.yaml.njk
  vars:
    pageId: lowdefy-schema
    pageTitle: Lowdefy App Schema
    section: Concepts
    filePath: concepts/lowdefy-schema.yaml
    content:
      - id: md1
        type: MarkdownWithCode
        properties:
          content: |
            A Lowdefy app is written as YAML files, which are combined together using the `_ref` operator when the app is built, into a configuration object that describes the entire app. This object has different sections that describe different parts of the app.

      - id: yaml_understanding_alert
        type: Alert
        properties:
          type: warning
          showIcon: false
          message: |
            A good understanding of YAML is needed before starting with Lowdefy. If you don't have any experience using YAML, you can find a good introduction video <a href = "https://www.youtube.com/watch?v=cdLNKUoMc6c">here</a>.

      - id: md2
        type: MarkdownWithCode
        properties:
          content: |
            The root schema for a Lowdefy app is:
            - `lowdefy: string`: __Required__ - The Lowdefy version number that the app uses. This is required and cannot be a reference to another file.
            - `name: string`: A name for the application.
            - `version: string`: The version number of the app that you are building. This is optional and allows you indicate the version of your app.
            - `license: string`: A [SPDX license ID](https://spdx.org/licenses/). You can use this to indicate the project's license if you are licensing your project under a specific software license. If you wish to indicate to others that you do not grant the right to use your project, you can optionally use `UNLICENSED` for this field. How you share your Lowdefy config is up to you.
            - `cli: object`: An object with configuration for the CLI.
            - `config: object`: An object with app configuration like the home page pageId.
            - `auth: object` An object with auth configuration such as providers and an adapter.
            - `global: object`: A data object that can be accessed anywhere in the app using the [`_global`](/_global) operator.
            - `connections: object[]`: An array of [`connection`](/connections-and-requests) objects.
            - `plugins: object[]`: An array of `plugin` objects to customize and add block types.
            - `menus: object[]`: An array of menu objects.
            - `pages: object[]`: An array of page objects.

            Pages are made up of blocks. Blocks have the following basic schema:
            - `id: string`: __Required__ - A unique identifier for a block.
            - `type: string`: __Required__ - This is the block type identifier and defines what block to used.
            - `properties: object`: All the settings passed to a block component.
            - `blocks: array`: An array of blocks to render within this block.

            Find the more detailed block schema [here](/blocks).

      - id: yaml_json_files_alert
        type: Alert
        properties:
          type: info
          showIcon: false
          message: |
            <h3> YAML file extensions </h3>
            <p> Both files with the <code>.yaml</code> and <code>.yml</code> file extensions are supported as YAML files. </p>
            <h3> JSON instead of YAML </h3>
            <p> Since you can reference JSON files, you can build your app using JSON instead of YAML files. The <code>lowdefy.yaml</code> file needs to be a YAML file, but all other configuration can be in referenced JSON files. It also makes sense to use JSON instead of YAML if you are generating configuration using code. </p>

      - id: md3
        type: MarkdownWithCode
        properties:
          content: |
            ## Config

            The config object has the following properties:

            - `basePath: string`: Set the base path to serve the Lowdefy application from. This will route all pages under `https://example.com/<base-path>/<page-id>` instead of the default `https://example.com/<page-id>`. The basePath value must start with "/".
            - `homePageId: string`: The pageId of the page that should be loaded when a user loads the app without a pageId in the url route. This is the page that is loaded when you navigate to `yourdomain.com`.

            ## Auth

            [TODO]: <> (# TODO: Add auth things here)

            ## Global

            Any data that you wish to use in your app can be stored in the __global__ object, and accessed using the [`_global`](/_global) operator. This is a good place to store data or configuration that is used throughout the app, for example the url of a logo or configuration of a page, since then these are only written once, and can be updated easily.

            The global object can also be modified using the [`SetGlobal`](/SetGlobal) action.

            ## Connections

            In a Lowdefy app you can integrate with other services like API's or databases using `connections` and `requests`. Connections configure the connection settings to the service, and often contain parameters like connection strings, urls and secrets such as passwords or API keys. Requests are used to interact with the connection, for example inserting a data record, executing a query or calling a API end-point.

            See more about how `connections` and `requests` are used together [here](/connections-and-requests).

            ## Plugins

            [TODO]: <> (# TODO: Add plugins things here)

            ## Menus

            Menu objects are objects with links to pages. They are filtered to only show pages that the user is authorized to see and are used by blocks such as `PageSiderMenu` to render the links in the menu. If no menus are provided, a default menu is created, with links to all of the defined pages, and with their pageIds as menu item titles.

            See more about how menu objects are used and defined [here](/menus).

            ## Pages

            Pages in a Lowdefy app are actually just blocks, the building blocks of a Lowdefy app, with a few extra restrictions and features.

            Each page should have an `id` that is unique among all pages in the app. Each page is served with the `pageId` as the url route. That is, if you create a page with id `page1`, it will be served at `domain.com/page1`.

            [TODO]: <> (# TODO: Below will change once we add the head configuration option on pages. Discuss that here.)

            If `properties.title` is set on a page block, the title will be set as the page title (This is the title displayed on the tabs in your browser).

            Let's have a look at how to define a page and it's blocks. We can start with a simple page a card block on it. We can add a title block and a paragraph block to our card so that it won't be so empty.

            ###### lowdefy.yaml
            ```yaml
            lowdefy: LOWDEFY_VERSION

            pages:
              - id: page1
                type: PageHeaderMenu
                properties:
                  title: Page 1
                blocks:
                  - id: content_card
                    type: Card
                    blocks:
                      - id: title
                        type: Title
                        properties:
                          content: Title
                      - id: paragraph
                        type: Paragraph
                        properties:
                          content: This is a paragraph on Page 1.
            ```

            Let's add another card to our page and give it some blocks which will allow us to get input from the user.

            ###### lowdefy.yaml
            ```yaml
            lowdefy: LOWDEFY_VERSION

            pages:
              - id: page1
                type: PageHeaderMenu
                properties:
                  title: Page 1
                blocks:
                  - id: content_card
                    type: Card
                    blocks:
                      - id: title
                        type: Title
                        properties:
                          content: Title
                      - id: paragraph
                        type: Paragraph
                        properties:
                          content: This is a paragraph on Page 1.
                  - id: input_card
                    type: Card
                    blocks:
                      - id: text_input
                        type: TextInput
                        properties:
                          label:
                            title: Please Enter Your Name
                      - id: radio_selector
                        type: RadioSelector
                        properties:
                          label:
                            title: How Are You Feeling?
                            colon: false
                          options:
                            - label: Meh
                              value: 1
                              disabled: false
                            - label: Okay
                              value: 2
                              disabled: false
                            - label: Good
                              value: 3
                              disabled: false
                            - label: Great
                              value: 4
                              disabled: false
                            - label: Amazing Now That I'm Using Lowdefy
                              value: 5
                              disabled: false
            ```

            In order to build our page further, we will need to add more blocks. Let's leave this page as is and add another page, with it's own card block containing a title block and a paragraph block.

            ###### lowdefy.yaml
            ```yaml
            lowdefy: LOWDEFY_VERSION

            pages:
              - id: page1
                type: PageHeaderMenu
                properties:
                  title: Page 1
                blocks:
                  - id: content_card
                    type: Card
                    blocks:
                      - id: title
                        type: Title
                        properties:
                          content: Title
                      - id: paragraph
                        type: Paragraph
                        properties:
                          content: This is a paragraph on Page 1.
                  - id: input_card
                    type: Card
                    blocks:
                      - id: text_input
                        type: TextInput
                        properties:
                          label:
                            title: Please Enter Your Name
                      - id: radio_selector
                        type: RadioSelector
                        properties:
                          label:
                            title: How Are You Feeling?
                            colon: false
                          options:
                            - label: Meh
                              value: 1
                              disabled: false
                            - label: Okay
                              value: 2
                              disabled: false
                            - label: Good
                              value: 3
                              disabled: false
                            - label: Great
                              value: 4
                              disabled: false
                            - label: Amazing Now That I'm Using Lowdefy
                              value: 5
                              disabled: false
              - id: page2
                type: PageHeaderMenu
                properties:
                  title: Page 2
                blocks:
                  - id: content_card
                    type: Card
                    blocks:
                      - id: title
                        type: Title
                        properties:
                          content: Title
                      - id: paragraph
                        type: Paragraph
                        properties:
                          content: This is a paragraph on Page 2.
            ```

            In order to keep files neat and generally easier to read and understand, we suggest making use of references and templating.

            ## References and templates

            References are used to split the configuration of an app into logically distinct files, and to reuse configuration in the app. References can be used almost anywhere in the configuration, as long as the configuration remains valid YAML.

            Templating can be taken further by referencing [Nunjucks](https://mozilla.github.io/nunjucks/) template files. Nunjucks templates are useful since the template file does not need to be valid yaml before it is hydrated, and features like for-loops and if-statements can be used.

            See more about references and templates [here](/references-and-templates).

            ## Lowdefy versions and version updates

            Lowdefy is versioned using semantic versioning, with a three part version number, with the form `major.minor.patch`. Lowdefy is in the early stages of development and under active development, with new versions published on a regular basis.

            To update the version of your app, change the `lowdefy` version field in the `lowdefy.yaml` file, and redeploy the app. You might also need to make some changes to your app configuration to be compatible with the new version.

            Patch updates only contain fixes, and you should be safe to update to a patched version without any changes to your app. Since we are actively developing new features, most releases will be minor version updates, and patches won't be made to older versions.

            Minor version changes include new features. At this stage, since the project is still in early development, they might also have minor breaking changes to individual blocks, actions, operators or connections. Please check the [changelog](https://github.com/lowdefy/lowdefy/blob/main/CHANGELOG.md) to see if any configuration changes are needed before updating.

            Major version updates may include major breaking changes or architecture changes. You might need to make more changes to your configuration to be compatible with the new version. We don't intend to release major versions regularly, and try to minimize breaking changes.

            As the project grows, we will release a long term support (LTS) version, that will continue to receive patches, but won't have any breaking changes.

      - _ref:
          path: templates/navigation_buttons.yaml
          vars:
            previous_page_title: The CLI
            previous_page_id: cli
            next_page_title: Context and State
            next_page_id: context-and-state
